# HR-COBOL v1.2.0 Implementation Specification

**Document ID**: HR-COBOL-V1.2.0-SPEC  
**Version**: 1.2.0  
**Date**: 2025-11-03  
**Status**: Specification  
**Target**: Complete Deferred Operations and Add Enhanced Features

---

## Executive Summary

This specification defines the implementation plan for HR-COBOL v1.2.0, building upon the completed v1.1.0 release. The focus is on implementing the two deferred employee operations (TRANSFER and REHIRE) and adding additional features to enhance the system's capabilities.

**Scope:** Implement TRANSFER and REHIRE operations, add enhanced validation, improve error handling, and add batch import capability.

**Estimated Effort:** 30-40 hours of development time

**Dependencies:** v1.1.0 must be complete and error-free (✅ Done with fixes)

---

## 1. Version Overview

### 1.1 Goals

**Primary Goals:**
- ✅ Implement EMP-SVC TRANSFER operation (department transfers)
- ✅ Implement EMP-SVC REHIRE operation (rehire terminated employees)
- ✅ Add comprehensive validation utilities
- ✅ Enhance error messaging with ERR-UTIL integration
- ✅ Add employee import batch program (IMPEMP)

**Secondary Goals:**
- ✅ Improve department capacity management
- ✅ Add enhanced audit logging for complex operations
- ✅ Implement data validation rules
- ✅ Create comprehensive test data sets

### 1.2 Out of Scope (Deferred to v1.3.0+)

- ❌ PAY-SVC implementation (payroll calculations)
- ❌ RULE-SVC implementation (table-driven business rules)
- ❌ RPT-SVC implementation (reporting engine)
- ❌ Authentication/Authorization (AUTHN-SVC, AUTH-SVC)
- ❌ Multi-currency foreign exchange (FX-SVC)
- ❌ VSAM file organization migration
- ❌ Automated testing framework
- ❌ REST API bridge

### 1.3 Success Criteria

1. TRANSFER operation moves employees between departments atomically
2. Department headcounts update correctly during transfers
3. REHIRE operation creates new employee records for terminated employees
4. REHIRE respects configuration for ID reuse policy
5. All operations handle edge cases gracefully
6. Audit trail captures all complex operations with sufficient detail
7. Build passes with no errors or warnings
8. Manual testing confirms all operations work end-to-end
9. Import batch program successfully processes CSV files

---

## 2. Verification of v1.0.0 and v1.1.0

### 2.1 Issues Found and Corrected

#### Issue #1: Missing WS-DATE-2 Variable
**Severity:** Critical (Build Failure)  
**Files Affected:** 
- `hr-cobol/src/svc/EMP-SVC.cbl`
- `hr-cobol/src/svc/DEPT-SVC.cbl`

**Problem:** Both service files call DATE-UTIL with 5 parameters, but the working storage only defined 4 variables. The WS-DATE-2 variable was missing, causing compilation errors.

**Root Cause:** Oversight during initial implementation. DATE-UTIL signature requires LS-DATE-2 even for operations like GET-CURRENT that don't use it.

**Fix Applied:** Added `01 WS-DATE-2 PIC 9(8).` to working storage in both files after WS-DATE-1.

**Verification:** All programs now compile successfully without errors.

### 2.2 Implementation Completeness Review

#### v1.0.0 Implementation
**Status:** Foundation complete  
**Completion:** ~30% of full specification

**Implemented:**
- ✅ Complete copybook infrastructure (17 copybooks)
- ✅ Service architecture foundation
- ✅ EMP-SVC ADD operation
- ✅ DEPT-SVC ADD operation (basic)
- ✅ DATE-UTIL VALIDATE operation
- ✅ DAO-FILE PUT operation (basic)
- ✅ HRMENU driver with menu system

**Limitations Identified:**
- No actual data persistence (DAO-FILE PUT doesn't read back)
- Hardcoded ID sequences
- No validation beyond basic field checks
- No integration between services

#### v1.1.0 Implementation
**Status:** Core services complete  
**Completion:** ~60% of full specification

**Implemented:**
- ✅ SEQ-SVC for centralized ID generation
- ✅ DAO-FILE complete (GET, PUT, UPDATE, DELETE, SCAN)
- ✅ EMP-SVC operations: ADD, FIND, UPDATE, TERMINATE
- ✅ DEPT-SVC operations: ADD, FIND, UPDATE, DELETE
- ✅ AUDIT-LOG for audit trail
- ✅ ERR-UTIL for error formatting
- ✅ Optimistic locking with REC-VERSION
- ✅ Persistent storage with file-based DAO

**Deferred Operations:**
- ⏳ EMP-SVC TRANSFER (not implemented)
- ⏳ EMP-SVC REHIRE (not implemented)

**Quality Assessment:**
- Build Status: ✅ PASSING (after fix)
- Code Quality: ✅ HIGH (clean architecture, well-documented)
- Error Handling: ✅ COMPREHENSIVE (status codes, detailed messages)
- Data Integrity: ✅ GOOD (optimistic locking, validation)

### 2.3 Recommendations from Review

1. **Continue with current architecture** - Service layer design is solid
2. **Maintain consistency** - Follow established patterns for new operations
3. **Enhance validation** - Add more comprehensive field validation
4. **Improve testing** - Create test data sets and manual test scenarios
5. **Document edge cases** - Capture business rules for complex operations

---

## 3. New Features for v1.2.0

### 3.1 EMP-SVC TRANSFER Operation

#### 3.1.1 Overview
**Operation Code:** `OP-TRANSFER` (value: 'T')  
**Purpose:** Transfer an employee from one department to another with effective dating

**Business Rules:**
1. Employee must be active (EMP-STATUS = 'A')
2. Source department must exist
3. Target department must exist
4. Target department must have available capacity
5. Transfer creates new employee record with new VALID-FROM
6. Old employee record gets VALID-TO set to day before transfer
7. Department headcounts update atomically
8. All changes must succeed or all must fail (atomic operation)

#### 3.1.2 Request Structure
```cobol
EMP-SVC-REQ.
  OP-CODE         PIC X(1) VALUE 'T'.
  IN-EMP.
    EMP-ID        PIC 9(9).        *> Employee to transfer
    DEPT-ID       PIC 9(9).        *> New department ID
    VALID-FROM    PIC 9(8).        *> Transfer effective date
```

#### 3.1.3 Response Structure
```cobol
EMP-SVC-RES.
  STATUS-CODE-N   PIC 9(4).
  STATUS-MSG      PIC X(200).
  CORR-ID         PIC X(16).
  OUT-EMP.                         *> New employee record if successful
```

#### 3.1.4 Algorithm

```
TRANSFER-EMPLOYEE:
  1. Validate input
     - EMP-ID must be provided and > 0
     - New DEPT-ID must be provided and > 0
     - VALID-FROM must be valid date and >= current date
     
  2. Get current employee record
     - Call DAO-FILE GET with EMP-ID
     - If not found, return 404
     - If found but not ACTIVE, return 422 "Employee is not active"
     
  3. Verify employee is in current department
     - Check VALID-TO is 99991231 (currently active record)
     
  4. Get source department
     - Call DEPT-SVC FIND with current DEPT-ID
     - If not found, return 404 "Source department not found"
     
  5. Get target department
     - Call DEPT-SVC FIND with new DEPT-ID
     - If not found, return 404 "Target department not found"
     
  6. Check target department capacity
     - If target HEADCOUNT >= target CAPACITY
       - If CAPACITY-POLICY = 'B' (block), return 409 "Department at capacity"
       - If CAPACITY-POLICY = 'W' (warn), log warning but continue
       
  7. Close current employee record
     - Set VALID-TO = VALID-FROM - 1 day
     - Increment REC-VERSION
     - Call DAO-FILE UPDATE with old record
     - If fails, return error and rollback
     
  8. Create new employee record
     - Copy all fields from old record
     - Set new DEPT-ID
     - Set VALID-FROM to transfer date
     - Set VALID-TO to 99991231
     - Set REC-VERSION = 1 (new record)
     - Call DAO-FILE PUT with new record
     - If fails, return error and rollback
     
  9. Update source department headcount
     - Decrement HEADCOUNT by 1
     - Call DEPT-SVC UPDATE
     - If fails, return error and rollback
     
  10. Update target department headcount
      - Increment HEADCOUNT by 1
      - Call DEPT-SVC UPDATE
      - If fails, return error and rollback
      
  11. Audit log
      - ACTION = 'TRANSFER'
      - BEFORE-VALUE = old employee record (first 120 chars)
      - AFTER-VALUE = new employee record (first 120 chars)
      - Include both old and new DEPT-ID in audit
      
  12. Success
      - Return STATUS-CODE-N = 0
      - Return new employee record in OUT-EMP
      - STATUS-MSG = "Employee transferred successfully from DEPT-ID=xxx to DEPT-ID=yyy"
```

#### 3.1.5 Error Scenarios

| Error | Status Code | Message | Recovery |
|-------|-------------|---------|----------|
| Missing EMP-ID | 422 | "Missing EMP-ID for transfer" | Provide EMP-ID |
| Missing DEPT-ID | 422 | "Missing target DEPT-ID" | Provide DEPT-ID |
| Invalid date | 422 | "Invalid VALID-FROM date" | Provide valid date |
| Employee not found | 404 | "Employee not found: EMP-ID=xxx" | Check EMP-ID |
| Employee not active | 422 | "Employee is not active" | Cannot transfer |
| Source dept not found | 404 | "Source department not found" | Data integrity issue |
| Target dept not found | 404 | "Target department not found: DEPT-ID=xxx" | Check DEPT-ID |
| Target dept at capacity | 409 | "Department at capacity: DEPT-ID=xxx" | Choose different dept or increase capacity |
| DAO error | 500 | "Error during transfer: [detail]" | Check logs, retry |
| Version conflict | 409 | "Version conflict - retry operation" | Retry with fresh data |

#### 3.1.6 Rollback Strategy

Since we don't have transaction support, we implement compensating actions:
- If step N fails, undo steps N-1, N-2, ... in reverse order
- Log all rollback actions for audit trail
- Return detailed error message indicating failure point

**Implementation Note:** For v1.2.0, we accept the risk of partial failure. Full transaction support is deferred to v1.3.0 with VSAM or DB2.

#### 3.1.7 Testing Scenarios

1. **Happy path** - Transfer active employee to department with capacity
2. **At capacity** - Transfer to department at capacity (test both WARN and BLOCK)
3. **Invalid employee** - Try to transfer non-existent employee
4. **Invalid department** - Try to transfer to non-existent department
5. **Not active** - Try to transfer terminated employee
6. **Same department** - Transfer to same department (should work but log warning)
7. **Past date** - Try to transfer with past effective date (should fail)
8. **Concurrent update** - Two users try to transfer same employee simultaneously

---

### 3.2 EMP-SVC REHIRE Operation

#### 3.2.1 Overview
**Operation Code:** `OP-REHIRE` (value: 'R')  
**Purpose:** Rehire a previously terminated employee with new employment terms

**Business Rules:**
1. Employee must have been terminated (EMP-STATUS = 'T')
2. Must find the most recent terminated record by VALID-TO
3. REHIRE-DATE must be > last VALID-TO (no date overlap)
4. Creates new employee record with new effective date range
5. May reuse EMP-ID or generate new one (based on REHIRE-REUSE-ID config)
6. Can assign to same or different department
7. All fields reset except name and personal information
8. New hire date = rehire date
9. New REC-VERSION = 1

#### 3.2.2 Request Structure
```cobol
EMP-SVC-REQ.
  OP-CODE         PIC X(1) VALUE 'R'.
  Q-EMP-ID        PIC 9(9).        *> Original employee ID to rehire
  IN-EMP.
    DEPT-ID       PIC 9(9).        *> New department (required)
    VALID-FROM    PIC 9(8).        *> Rehire date (required)
    EMP-TYPE      PIC X(1).        *> New employment type (F/P/C)
    *> Other fields optional - will use defaults if not provided
```

#### 3.2.3 Response Structure
```cobol
EMP-SVC-RES.
  STATUS-CODE-N   PIC 9(4).
  STATUS-MSG      PIC X(200).
  CORR-ID         PIC X(16).
  OUT-EMP.
    EMP-ID        PIC 9(9).        *> New or reused employee ID
    *> Other fields from new employee record
```

#### 3.2.4 Algorithm

```
REHIRE-EMPLOYEE:
  1. Validate input
     - Q-EMP-ID must be provided and > 0
     - IN-EMP.DEPT-ID must be provided and > 0
     - IN-EMP.VALID-FROM must be valid date
     
  2. Find terminated employee record
     - Call DAO-FILE SCAN to find all records with Q-EMP-ID
     - Filter for EMP-STATUS = 'T'
     - Sort by VALID-TO descending
     - Take first record (most recent termination)
     - If not found, return 404 "No terminated employee found with EMP-ID=xxx"
     
  3. Validate rehire date
     - VALID-FROM must be > VALID-TO of terminated record
     - VALID-FROM must be >= current date (optional: allow future hiring)
     - If invalid, return 422 "Rehire date must be after termination date"
     
  4. Verify new department exists
     - Call DEPT-SVC FIND with IN-EMP.DEPT-ID
     - If not found, return 404 "Department not found"
     - Check capacity
     
  5. Determine employee ID
     - If REHIRE-REUSE-ID = 'Y' in config:
       - Reuse Q-EMP-ID
     - If REHIRE-REUSE-ID = 'N':
       - Call SEQ-SVC NEXT to get new EMP-ID
       
  6. Create new employee record
     - Copy personal info from terminated record:
       - LAST-NAME, FIRST-NAME, MIDDLE-NAME
       - LAST-NAME-KANA, FIRST-NAME-KANA
       - BIRTH-DATE
       - ADDRESS (optional - may allow update)
     - Set new employment fields:
       - EMP-ID (new or reused)
       - DEPT-ID = IN-EMP.DEPT-ID
       - EMP-TYPE = IN-EMP.EMP-TYPE or default to 'F'
       - EMP-STATUS = 'A' (Active)
       - HIRE-DATE = IN-EMP.VALID-FROM
       - VALID-FROM = IN-EMP.VALID-FROM
       - VALID-TO = 99991231
       - REC-VERSION = 1
       - RECORD-VERSION = 1
       
  7. Save new employee record
     - Call DAO-FILE PUT
     - If fails, return error
     
  8. Update department headcount
     - Increment HEADCOUNT by 1
     - Call DEPT-SVC UPDATE
     - If fails, rollback employee record (DAO-FILE DELETE)
     
  9. Audit log
     - ACTION = 'REHIRE'
     - BEFORE-VALUE = terminated record (first 120 chars)
     - AFTER-VALUE = new record (first 120 chars)
     - Note: Include both old and new EMP-ID if different
     
  10. Success
      - Return STATUS-CODE-N = 0
      - Return new employee record in OUT-EMP
      - STATUS-MSG = "Employee rehired successfully: OLD-EMP-ID=xxx NEW-EMP-ID=yyy"
```

#### 3.2.5 Configuration Impact

The REHIRE-REUSE-ID setting in config.cpy controls ID behavior:

```cobol
*> In config.cpy
05  REHIRE-REUSE-ID     PIC X     VALUE 'N'.
    88  REHIRE-REUSE        VALUE 'Y'.
    88  REHIRE-NEW-ID       VALUE 'N'.
```

- **REHIRE-REUSE-ID = 'Y'**: Reuse original employee ID
  - Advantages: Preserves employment history link, simpler for reporting
  - Disadvantages: Complex queries to distinguish employment periods
  
- **REHIRE-REUSE-ID = 'N'**: Generate new employee ID
  - Advantages: Cleaner separation, simpler queries per employment period
  - Disadvantages: Lost link to previous employment (except via audit log)

**Recommendation:** Default to 'N' (new ID) for cleaner data model.

#### 3.2.6 Error Scenarios

| Error | Status Code | Message | Recovery |
|-------|-------------|---------|----------|
| Missing EMP-ID | 422 | "Missing EMP-ID for rehire" | Provide EMP-ID |
| Missing DEPT-ID | 422 | "Missing target DEPT-ID" | Provide DEPT-ID |
| Missing rehire date | 422 | "Missing VALID-FROM (rehire date)" | Provide date |
| No terminated record | 404 | "No terminated employee found: EMP-ID=xxx" | Check EMP-ID |
| Invalid rehire date | 422 | "Rehire date must be after termination date" | Use later date |
| Department not found | 404 | "Department not found: DEPT-ID=xxx" | Check DEPT-ID |
| Dept at capacity | 409 | "Department at capacity" | Choose different dept |
| DAO error | 500 | "Error during rehire: [detail]" | Check logs |
| Sequence error | 500 | "Unable to generate new EMP-ID" | Check SEQ-SVC |

#### 3.2.7 Testing Scenarios

1. **Happy path** - Rehire terminated employee with reuse ID
2. **New ID** - Rehire with REHIRE-REUSE-ID = 'N'
3. **No terminated record** - Try to rehire active or non-existent employee
4. **Date overlap** - Try to rehire with date <= termination date
5. **Department capacity** - Rehire to department at capacity
6. **Multiple terminations** - Employee terminated twice, rehire uses most recent
7. **Changed department** - Rehire to different department than termination
8. **Missing fields** - Rehire with minimal data, verify defaults

---

### 3.3 Enhanced Validation

#### 3.3.1 Date Validation Enhancement

Enhance DATE-UTIL with more comprehensive validation:

```cobol
*> In DATE-UTIL
VALIDATE-DATE.
    PERFORM CHECK-DATE-FORMAT
    IF DATE-VALID
        PERFORM CHECK-MONTH-DAYS
    END-IF
    IF DATE-VALID
        PERFORM CHECK-LEAP-YEAR
    END-IF
    .

CHECK-MONTH-DAYS.
    *> Validate day is valid for month
    *> e.g., no day 31 in April, June, September, November
    .

CHECK-LEAP-YEAR.
    *> Validate Feb 29 only in leap years
    .
```

#### 3.3.2 Field Validation Rules

Add validation helper paragraphs:

```cobol
*> In EMP-SVC
VALIDATE-NAME-FIELD.
    *> Check LAST-NAME is not spaces
    *> Check FIRST-NAME is not spaces
    *> Check length >= MIN-NAME-LENGTH
    *> Check for invalid characters (numbers, special chars)
    .

VALIDATE-ADDRESS.
    *> Check at least ADDRESS-LINE-1 is provided
    *> Check POSTAL-CODE format (if provided)
    *> Check COUNTRY-CODE is valid (if provided)
    .

VALIDATE-EMP-TYPE.
    *> Check EMP-TYPE is 'F', 'P', or 'C'
    .

VALIDATE-DATES.
    *> Check HIRE-DATE <= current date
    *> Check BIRTH-DATE < HIRE-DATE (employee must be born before hired)
    *> Check BIRTH-DATE > MIN-VALID-DATE (reasonable birth year)
    *> Check VALID-FROM <= VALID-TO
    .
```

---

### 3.4 Batch Import Program (IMPEMP)

#### 3.4.1 Overview

**Program:** IMPEMP (Import Employees)  
**Type:** Batch  
**Purpose:** Bulk import employee records from CSV file

**Features:**
- Read CSV file with employee data
- Validate each record
- Call EMP-SVC ADD for each valid record
- Generate import report with success/failure counts
- Error log with line numbers and error details

#### 3.4.2 File Structure

**Input File:** `data/import/employees.csv`

```csv
LAST_NAME,FIRST_NAME,MIDDLE_NAME,LAST_NAME_KANA,FIRST_NAME_KANA,BIRTH_DATE,DEPT_ID,EMP_TYPE,HIRE_DATE,ADDRESS_LINE_1,CITY,STATE,POSTAL,COUNTRY
Smith,John,A,スミス,ジョン,19850615,1,F,20231101,123 Main St,Tokyo,Tokyo,100-0001,JPN
Tanaka,Yuki,,田中,ユキ,19900320,2,P,20231115,456 Oak Ave,Osaka,Osaka,530-0001,JPN
```

**Output Files:**
- `data/import/employees.log` - Import log with summary
- `data/import/employees.err` - Error details for failed records

#### 3.4.3 Algorithm

```
IMPEMP-MAIN:
  1. Initialize counters
     - Total records read = 0
     - Successful imports = 0
     - Failed imports = 0
     
  2. Open input CSV file
     - If fails, write error and terminate
     
  3. Read and skip header line
  
  4. Loop through data lines
     - Read CSV line
     - Increment total records counter
     - Parse CSV into employee structure
     - Validate record
     - If valid:
       - Call EMP-SVC ADD
       - If success:
         - Increment success counter
         - Log success
       - If failure:
         - Increment failure counter
         - Write to error log
     - If invalid:
       - Increment failure counter
       - Write to error log
       
  5. Close files
  
  6. Write summary report
     - Total records processed
     - Successful imports
     - Failed imports
     - Error details (if any)
     
  7. Set exit code
     - 0 if all succeeded
     - 4 if some failed
     - 8 if all failed
     - 12 if file error
```

#### 3.4.4 CSV Parsing

Simple CSV parser for fixed format:
- Fields separated by commas
- No quoted fields (for simplicity in v1.2.0)
- Empty fields represented as consecutive commas
- One record per line

**Implementation Note:** Use STRING/UNSTRING for parsing. Full CSV parser with quoted fields deferred to v1.3.0.

#### 3.4.5 Error Handling

- Invalid CSV format → Log error, skip record, continue
- Missing required fields → Log error, skip record, continue
- EMP-SVC errors → Log error, skip record, continue
- File I/O errors → Terminate with error message

---

## 4. Implementation Tasks

### 4.1 Phase 1: EMP-SVC TRANSFER Operation

**Priority:** HIGH  
**Estimated Effort:** 12 hours

#### Task 1.1: Implement TRANSFER logic in EMP-SVC
**Files to Modify:**
- `hr-cobol/src/svc/EMP-SVC.cbl`

**Steps:**
1. Replace stub implementation with full algorithm
2. Add validation for transfer-specific fields
3. Implement department lookup logic
4. Implement capacity checking
5. Implement atomic multi-step operation
6. Add compensating rollback logic
7. Enhance audit logging for transfers

**Acceptance Criteria:**
- [x] Validates all input fields
- [x] Checks source and target departments exist
- [x] Enforces capacity limits
- [x] Creates new employee record with correct dates
- [x] Closes old employee record
- [x] Updates department headcounts
- [x] Logs comprehensive audit trail
- [x] Handles errors gracefully with rollback
- [x] Returns detailed success/error messages

#### Task 1.2: Test TRANSFER operation
**Estimated Effort:** 3 hours

**Test Scenarios:**
1. Transfer between departments with capacity
2. Transfer to department at capacity (WARN mode)
3. Transfer to department at capacity (BLOCK mode)
4. Transfer with future effective date
5. Transfer non-existent employee
6. Transfer to non-existent department
7. Transfer terminated employee (should fail)
8. Concurrent transfers (version conflict)

### 4.2 Phase 2: EMP-SVC REHIRE Operation

**Priority:** HIGH  
**Estimated Effort:** 10 hours

#### Task 2.1: Implement REHIRE logic in EMP-SVC
**Files to Modify:**
- `hr-cobol/src/svc/EMP-SVC.cbl`

**Steps:**
1. Replace stub implementation with full algorithm
2. Add logic to find most recent terminated record
3. Implement date overlap validation
4. Add ID reuse/generation logic based on config
5. Implement new record creation with field copying
6. Add department headcount update
7. Enhance audit logging

**Acceptance Criteria:**
- [x] Finds most recent terminated record
- [x] Validates rehire date > termination date
- [x] Respects REHIRE-REUSE-ID configuration
- [x] Copies personal information correctly
- [x] Resets employment fields appropriately
- [x] Updates department headcount
- [x] Logs comprehensive audit trail
- [x] Returns new employee record

#### Task 2.2: Test REHIRE operation
**Estimated Effort:** 3 hours

**Test Scenarios:**
1. Rehire with ID reuse (REHIRE-REUSE-ID = 'Y')
2. Rehire with new ID (REHIRE-REUSE-ID = 'N')
3. Rehire to same department
4. Rehire to different department
5. Rehire with overlapping dates (should fail)
6. Rehire non-terminated employee (should fail)
7. Multiple terminations, verify uses most recent
8. Missing required fields

### 4.3 Phase 3: Enhanced Validation

**Priority:** MEDIUM  
**Estimated Effort:** 8 hours

#### Task 3.1: Enhance DATE-UTIL
**Files to Modify:**
- `hr-cobol/src/util/DATE-UTIL.cbl`

**Steps:**
1. Add month-days validation
2. Add leap year calculation
3. Add Feb 29 validation
4. Add more comprehensive format checking

**Acceptance Criteria:**
- [x] Rejects invalid days for each month
- [x] Correctly identifies leap years
- [x] Rejects Feb 29 in non-leap years
- [x] Returns detailed error codes

#### Task 3.2: Add validation helpers to EMP-SVC
**Files to Modify:**
- `hr-cobol/src/svc/EMP-SVC.cbl`

**Steps:**
1. Add VALIDATE-NAME-FIELD paragraph
2. Add VALIDATE-ADDRESS paragraph
3. Add VALIDATE-EMP-TYPE paragraph
4. Add VALIDATE-DATES paragraph
5. Integrate into ADD operation
6. Integrate into UPDATE operation

**Acceptance Criteria:**
- [x] All ADD operations validate names
- [x] Address validation checks minimal requirements
- [x] Employment type restricted to valid values
- [x] Date relationships validated (birth < hire, etc.)

### 4.4 Phase 4: Batch Import (IMPEMP)

**Priority:** MEDIUM  
**Estimated Effort:** 10 hours

#### Task 4.1: Create IMPEMP program
**Files to Create:**
- `hr-cobol/src/batch/IMPEMP.cbl`

**Steps:**
1. Create program structure
2. Implement CSV file reading
3. Implement CSV parsing (UNSTRING)
4. Add record validation
5. Add EMP-SVC integration
6. Implement error logging
7. Implement summary reporting

**Acceptance Criteria:**
- [x] Reads CSV file successfully
- [x] Parses CSV records correctly
- [x] Validates each record
- [x] Calls EMP-SVC ADD for valid records
- [x] Logs errors for invalid records
- [x] Generates summary report
- [x] Sets appropriate exit code

#### Task 4.2: Create sample CSV data
**Files to Create:**
- `hr-cobol/data/import/employees.csv`
- `hr-cobol/data/import/README.md`

**Steps:**
1. Create sample CSV with 20 valid records
2. Add 5 invalid records for error testing
3. Document CSV format
4. Document import procedure

#### Task 4.3: Update Makefile
**Files to Modify:**
- `Makefile-HR`

**Steps:**
1. Add IMPEMP compilation target
2. Add import data directory creation
3. Add clean target for import logs

### 4.5 Phase 5: Integration & Testing

**Priority:** HIGH  
**Estimated Effort:** 5 hours

#### Task 5.1: Integration testing
**Test Scenarios:**
1. Add employee → Transfer → Verify department headcounts
2. Add employee → Terminate → Rehire → Verify new record
3. Import batch → Verify all employees created
4. Complex workflow: Import → Transfer several → Terminate → Rehire
5. Error scenarios for each operation
6. Concurrent operation scenarios

#### Task 5.2: Update documentation
**Files to Update:**
- `hr-cobol/README.md`
- `hr-cobol/QUICKSTART.md`
- `hr-cobol/doc/IMPLEMENTATION-STATUS.md`
- `hr-cobol/doc/V1.2.0-RELEASE-SUMMARY.md` (new)

---

## 5. Data Structures

### 5.1 No New Copybooks Required

All necessary data structures already exist in v1.1.0:
- `employee.cpy` - Employee record (supports effective dating)
- `department.cpy` - Department record (has capacity and headcount)
- `emp-req.cpy` / `emp-res.cpy` - Request/response structures
- `audit.cpy` - Audit record (sufficient for complex operations)

### 5.2 Configuration Changes

Update `config.cpy` to ensure REHIRE-REUSE-ID is documented:

```cobol
*> Rehire Policy
05  REHIRE-REUSE-ID     PIC X     VALUE 'N'.
    88  REHIRE-REUSE        VALUE 'Y'.
    88  REHIRE-NEW-ID       VALUE 'N'.
*> Y = Reuse original employee ID when rehiring
*> N = Generate new employee ID when rehiring (recommended)
```

---

## 6. Testing Strategy

### 6.1 Unit Testing (Manual)

For each new operation:

**TRANSFER:**
- Happy path with capacity available
- Department at capacity (WARN policy)
- Department at capacity (BLOCK policy)
- Invalid employee ID
- Invalid department ID
- Employee not active
- Future transfer date
- Same department transfer

**REHIRE:**
- Happy path with ID reuse
- Happy path with new ID
- No terminated record found
- Invalid rehire date (before termination)
- Invalid rehire date (overlapping)
- Department at capacity
- Multiple terminations (uses most recent)

**Validation:**
- Valid dates (month-day combinations)
- Invalid dates (e.g., Feb 30, Apr 31)
- Leap year Feb 29 (valid in 2024, invalid in 2023)
- Name validation (non-empty, no numbers)
- Address validation (minimal requirements)
- Employment type validation

**Batch Import:**
- Valid CSV with all valid records
- CSV with some invalid records
- CSV with missing required fields
- CSV file not found
- Empty CSV file
- Large CSV (100+ records)

### 6.2 Integration Testing

**Complex Workflows:**
1. End-to-end employee lifecycle:
   - Add → Transfer (dept 1 → dept 2) → Transfer (dept 2 → dept 3) → Terminate → Rehire (dept 1)
   - Verify: All records created, headcounts correct, audit trail complete

2. Department capacity enforcement:
   - Create dept with capacity 5
   - Add 5 employees
   - Try to add 6th (should warn or block based on policy)
   - Transfer from another dept (should warn or block)

3. Batch import + operations:
   - Import 20 employees
   - Transfer 5 employees
   - Terminate 3 employees
   - Rehire 1 employee
   - Verify: Data integrity, headcounts, sequences

### 6.3 Error Handling Tests

**Validation Errors:**
- Missing required fields → 422
- Invalid field values → 422
- Invalid dates → 422

**Not Found Errors:**
- Non-existent employee → 404
- Non-existent department → 404

**Conflict Errors:**
- Department at capacity → 409
- Version conflict (concurrent update) → 409
- Invalid state (e.g., rehire active employee) → 409

**System Errors:**
- File I/O errors → 500
- DAO errors → 500

### 6.4 Performance Testing

**Targets:**
| Operation | Target (p95) | Notes |
|-----------|--------------|-------|
| TRANSFER | < 150ms | Multiple service calls |
| REHIRE | < 100ms | Record creation + department update |
| Validation | < 5ms | Additional overhead per operation |
| Batch import (100 records) | < 30 sec | ~300ms per record |

---

## 7. Rollback and Recovery

### 7.1 TRANSFER Rollback Scenarios

Since we don't have transactions, implement compensating actions:

```
If step fails:
  Step 7 (close old record): No rollback needed, no changes yet
  Step 8 (create new record): Delete new record if created
  Step 9 (update source dept): No rollback needed if didn't start
  Step 10 (update target dept): Decrement target dept if incremented
```

**Best Effort:** Log all rollback attempts in audit trail.

### 7.2 REHIRE Rollback Scenarios

```
If step fails:
  Step 7 (create record): Delete record if created
  Step 8 (update dept): Decrement headcount if incremented
```

**Future Enhancement:** v1.3.0 will add two-phase commit with VSAM or DB2.

---

## 8. Migration & Compatibility

### 8.1 Data Migration

**From v1.1.0 to v1.2.0:**
- No data migration required
- All existing data structures remain compatible
- No file format changes
- Existing employees.dat, departments.dat, sequences.dat unchanged

### 8.2 API Compatibility

- **Breaking changes:** None
- **New operations:** TRANSFER, REHIRE (backward compatible)
- **Enhanced validation:** May reject previously accepted invalid data (beneficial)
- **Deprecated:** None

### 8.3 Configuration Changes

Ensure `config.cpy` has REHIRE-REUSE-ID setting. If missing, add with default 'N'.

---

## 9. Performance Considerations

### 9.1 TRANSFER Performance

**Factors:**
- 2 DAO GET operations (employee + departments)
- 2 DAO UPDATE operations (close old record + update depts)
- 1 DAO PUT operation (new record)
- 2 DEPT-SVC calls (verify departments)
- 1 AUDIT-LOG call

**Estimated Time:** ~150ms for 5 DAO operations + service overhead

**Optimization Opportunities (v1.3.0):**
- Cache department records
- Batch department updates
- Use VSAM for faster random access

### 9.2 REHIRE Performance

**Factors:**
- 1 DAO SCAN operation (find terminated records)
- 1 SEQ-SVC call (if new ID)
- 1 DAO PUT operation (new record)
- 1 DEPT-SVC UPDATE call
- 1 AUDIT-LOG call

**Estimated Time:** ~100ms for SCAN + PUT + service overhead

**Optimization Opportunities:**
- Index on EMP-ID + EMP-STATUS for faster terminated record lookup

### 9.3 Batch Import Performance

**Factors:**
- CSV parsing (UNSTRING) - ~10ms per record
- Validation - ~5ms per record
- EMP-SVC ADD call - ~50ms per record
- Total: ~65ms per record
- 100 records: ~6.5 seconds

**Actual may vary:** Sequential file I/O, disk speed, etc.

---

## 10. Security Considerations

### 10.1 Input Validation

All user input validated:
- Employee IDs: numeric, > 0
- Department IDs: numeric, > 0
- Dates: valid format and values
- Names: not empty, no special characters
- Employment types: restricted to F/P/C

### 10.2 Audit Trail

All operations logged:
- User ID (from request)
- Correlation ID (for tracing)
- Timestamp (accurate to second)
- Before/after values (for complex operations)
- Result code

**Note:** Full authentication/authorization deferred to v1.3.0

### 10.3 Data Integrity

- Optimistic locking prevents lost updates
- Validation prevents invalid data entry
- Referential integrity enforced (dept must exist for employee)
- Date constraints enforced (no overlaps)

---

## 11. Documentation Deliverables

### 11.1 User Documentation

**New/Updated:**
- Operations guide for TRANSFER operation
- Operations guide for REHIRE operation
- Batch import guide for IMPEMP
- Error code reference (updated)

### 11.2 Technical Documentation

**New:**
- V1.2.0 Implementation Specification (this document)
- V1.2.0 Release Summary (after implementation)

**Updated:**
- README.md - Add v1.2.0 features
- QUICKSTART.md - Add TRANSFER/REHIRE examples
- IMPLEMENTATION-STATUS.md - Mark operations complete
- ARCHITECTURE.md - Document complex operation patterns

### 11.3 Code Documentation

- Inline comments for complex logic
- Algorithm descriptions in paragraphs
- Error handling documentation
- Business rules as comments

---

## 12. Acceptance Checklist

### 12.1 Functional Acceptance
- [ ] TRANSFER operation works end-to-end
- [ ] REHIRE operation works end-to-end
- [ ] Department headcounts update correctly during transfers
- [ ] ID reuse policy respected for rehires
- [ ] Enhanced validation catches invalid data
- [ ] Batch import processes CSV files correctly
- [ ] Error messages are clear and actionable
- [ ] Audit trail captures all operations

### 12.2 Technical Acceptance
- [ ] All programs compile without errors
- [ ] No memory leaks (visual inspection)
- [ ] File handles closed properly
- [ ] Error handling for all error paths
- [ ] Consistent coding style with v1.1.0
- [ ] Code comments for complex logic
- [ ] No hardcoded values (use constants)
- [ ] Rollback logic for complex operations

### 12.3 Testing Acceptance
- [ ] All unit test scenarios passed
- [ ] All integration scenarios passed
- [ ] Error scenarios handled correctly
- [ ] Performance targets met (dev env)
- [ ] No critical bugs

### 12.4 Documentation Acceptance
- [ ] Operations documented
- [ ] Technical spec complete (this document)
- [ ] Release summary written
- [ ] API reference updated
- [ ] Known limitations documented

---

## 13. Implementation Timeline

### Milestone 1: TRANSFER Operation (Week 1)
- [ ] Implement TRANSFER logic
- [ ] Test all scenarios
- [ ] Update documentation
- **Deliverable:** Working TRANSFER operation

### Milestone 2: REHIRE Operation (Week 2)
- [ ] Implement REHIRE logic
- [ ] Test all scenarios
- [ ] Update documentation
- **Deliverable:** Working REHIRE operation

### Milestone 3: Enhanced Validation (Week 3)
- [ ] Enhance DATE-UTIL
- [ ] Add validation helpers
- [ ] Test validation rules
- **Deliverable:** Comprehensive validation

### Milestone 4: Batch Import (Week 4)
- [ ] Implement IMPEMP
- [ ] Create sample data
- [ ] Test import scenarios
- [ ] Update build system
- **Deliverable:** Working batch import

### Milestone 5: Integration & Release (Week 5)
- [ ] Integration testing
- [ ] Documentation complete
- [ ] Release summary
- [ ] v1.2.0 released
- **Deliverable:** Production-ready v1.2.0

---

## 14. Post-Release Activities

### 14.1 Immediate (Week 6)
- Monitor for bugs
- Gather user feedback
- Document lessons learned

### 14.2 v1.3.0 Planning Topics
- PAY-SVC (Payroll calculations)
- RULE-SVC (Business rules engine)
- RPT-SVC (Reporting)
- VSAM migration (improved performance)
- Automated testing framework
- Transaction support (two-phase commit)
- Authentication/Authorization

---

## 15. Risks & Mitigations

### 15.1 Technical Risks

**Risk 1: Complex Operation Atomicity**  
**Probability:** Medium  
**Impact:** High  
**Mitigation:**
- Implement compensating rollback logic
- Comprehensive audit logging
- Clear error messages
- Accept risk for v1.2.0, add transactions in v1.3.0

**Risk 2: CSV Parsing Complexity**  
**Probability:** Medium  
**Impact:** Low  
**Mitigation:**
- Use simple CSV format (no quoted fields)
- Document format clearly
- Add format validation
- Defer complex CSV to v1.3.0

**Risk 3: Department Capacity Race Conditions**  
**Probability:** Low (single-user)  
**Impact:** Medium  
**Mitigation:**
- Document single-user limitation
- Add optimistic locking to departments
- Plan for multi-user in v1.3.0

### 15.2 Schedule Risks

**Risk 1: Feature Complexity**  
**Probability:** Medium  
**Impact:** Medium  
**Mitigation:**
- Conservative time estimates
- Incremental implementation
- Regular progress reviews
- Defer non-essential features if needed

---

## 16. Conclusion

HR-COBOL v1.2.0 completes the employee lifecycle management capabilities by implementing TRANSFER and REHIRE operations, adds enhanced validation to improve data quality, and introduces batch import functionality for efficient data loading.

**Key Deliverables:**
- TRANSFER operation (department transfers with effective dating)
- REHIRE operation (rehire terminated employees)
- Enhanced validation (dates, names, addresses)
- Batch import program (IMPEMP)
- Comprehensive documentation

**Value Proposition:**
- Complete employee lifecycle management
- Improved data quality through validation
- Efficient bulk data loading
- Comprehensive audit trail
- Production-ready foundation

**Recommendation:** Approve for implementation after v1.1.0 build fix verification.

---

**End of Specification**

---

## Document Control

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-11-03 | GitHub Copilot | Initial specification |

**Status:** Draft - Ready for Implementation
